<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Matching Game</title>
    <meta name="description" content="">
    <link rel="stylesheet prefetch" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
    <link rel="stylesheet prefetch" href="https://fonts.googleapis.com/css?family=Coda">
    <link rel="stylesheet" href="css/app.css">
    <link rel="stylesheet" href="css/animate.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Matching Game</h1>
        </header>
        <section class="score-panel">
        	<ul class="stars">
        		<li><i class="fa"></i></li>
        		<li><i class="fa"></i></li>
        		<li><i class="fa"></i></li>
        	</ul>
        	<span class="moves"></span> Moves
            <div class="restart">
        		<i class="fa fa-repeat"></i>
        	</div>
        </section>
        <ul class="deck">
            <li class="card">
                <i class="fa"></i>
            </li>
            <li class="card">
                <i class="fa"></i>
            </li>
            <li class="card">
                <i class="fa"></i>
            </li>
            <li class="card">
                <i class="fa"></i>
            </li>
            <li class="card">
                <i class="fa"></i>
            </li>
            <li class="card">
                <i class="fa"></i>
            </li>
            <li class="card">
                <i class="fa"></i>
            </li>
            <li class="card">
                <i class="fa"></i>
            </li>
            <li class="card">
                <i class="fa"></i>
            </li>
            <li class="card">
                <i class="fa"></i>
            </li>
            <li class="card">
                <i class="fa"></i>
            </li>
            <li class="card">
                <i class="fa"></i>
            </li>
            <li class="card">
                <i class="fa"></i>
            </li>
            <li class="card">
                <i class="fa"></i>
            </li>
            <li class="card">
                <i class="fa"></i>
            </li>
            <li class="card">
                <i class="fa"></i>
            </li>
        </ul>
    </div>
    <div class="layer">
        <i></i>
        <h4>Congratulations! You Won!</h4>
        <p>With <span class="stepNum"></span> Moves and <span class="starNum"></span> Stars.</p>
        <p>Wooooooo!</p>
        <a class="restart">Play Again</a>
    </div>
    <script src="js/jquery-3.1.1.min.js"></script>
    <script src="js/app.js"></script>
    <script>
        $(function () {
            var steps = [];//存储上次点击的节点
            var className= ['fa-diamond','fa-paper-plane-o','fa-anchor','fa-bolt',
                            'fa-cube','fa-leaf','fa-bicycle','fa-bomb'];
            var stepNum = 0;//存储匹配多少次
            $('body').on('click','.card:not(.match)',function () {
                var dom = $(this);
                openCard(dom);
                match(dom);
            });
            $('body').on('click','.restart',function () {
                $('.layer').fadeOut();
                init();
            });
            //初始化，得到重新开始游戏功能
            var init = function () {
                steps= [];
                stepNum = 0;
                $('.score-panel .moves').text(stepNum);
                $('.stars .fa').removeClass().addClass('fa fa-star');
                var domArray = $('.card .fa').removeClass().addClass('fa');
                var numArray = getRandom();
                var className2=className.concat(className);
                $('.card').removeClass().addClass('card');
                for(var i= 0,j=domArray.length;i<j;i++){
                    var x= numArray[i];
                    domArray.eq(x).addClass(className2[i]);
                }
            };
            var getRandom = function () {
                var N = 16;
                var arr = [];
                var ranArr = [];
                for (var i = 0; i < N; i++) {
                    arr[i] = i;
                }
                do {
                    var index = Math.floor(Math.random() * arr.length);
                    var flag = true;
                    ranArr.push(arr[index]);
                    arr.splice(index, 1);
                    if (arr.length == 0) {
                        flag = false;
                    }
                } while (flag);
                return ranArr;
            };
            var match = function (dom) {
                steps.push(dom);
                var length = steps.length;
                if(length > 1){
                    var beforDom =$( steps[0]);
                    if (beforDom.is(dom)){
                        console.log(steps.length,1)
                        steps.pop();
                    }else {
                        console.log(steps.length,2)
                        getStart();
                        if (getCardStyle(dom.children('.fa')) == getCardStyle(beforDom.children('.fa'))){
                            steps=[];
                            setTimeout(function () {
                                matchSuccess(beforDom);
                                matchSuccess(dom);
                                gameSuccess();
                            },300);
                        }else {
                            steps=[];
                            setTimeout(function () {
                                matchFaile(beforDom);
                                matchFaile(dom);
                            },300);
                        }
                    }
                }
            };
            var gameSuccess = function () {
                doms = $('.card');
                for (var i= 0,j=doms.length;i<j;i++){
                    if (!doms.eq(i).hasClass('match')){
                        console.log('game false');
                        return false;
                    }
                }
                console.log('game success');
                setTimeout(function () {
                    $('.layer').fadeIn();
                },1500);
                return true;
            }
            var matchSuccess = function (dom) {
                dom.addClass('rubberBand animated');
                dom.addClass('match');
                dom.removeClass('open show');
                dom.one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend',function () {
                    dom.removeClass('rubberBand animated');
                });
            };
            var matchFaile= function (dom) {
                dom.addClass('animated shake');
                dom.one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend',function () {
                    dom.removeClass('animated shake open show');
                });
            }
            //rubberBand
            var closeCard = function (dom) {
                console.log('cao');
                dom.addClass('flipInY animated');
                dom.one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function () {
                    dom.removeClass('flipInY animated');
                    dom.removeClass('open show');
                });
            };
            var openCard = function (dom) {
                dom.addClass('open show flipInY animated');
                dom.one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function () {
                    dom.removeClass('flipInY animated');
                });
            };
            var getCardStyle = function (dom) {
                 var nameArray = dom.prop("className").split(' ');
                return nameArray[1];
            };
            var getStart= function () {
                stepNum++;
                $('.score-panel .moves').text(stepNum);
                $('.layer .stepNum').text(stepNum);
                if (stepNum < 9){
                    $('.layer .starNum').text(3);
                }else if (stepNum<14){
                    $('.stars .fa').eq(2).removeClass('fa-star').addClass('fa-star-o');
                    $('.layer .starNum').text(2);
                }else {
                    $('.stars .fa').eq(1).removeClass('fa-star').addClass('fa-star-o')
                    $('.layer .starNum').text(3);
                }
            }
            getStart();
            init();
        });
    </script>
</body>
</html>
